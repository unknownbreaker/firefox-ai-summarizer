<!DOCTYPE html>
<html>
<head><title>Prompt Builder Test</title></head>
<body>
<pre id="output"></pre>
<script>
const browser = {
  storage: {
    sync: {
      _data: {},
      async get(keys) {
        const result = {};
        for (const k of keys) {
          if (k in this._data) result[k] = this._data[k];
        }
        return result;
      },
      async set(obj) { Object.assign(this._data, obj); }
    }
  }
};
</script>
<script src="../lib/prompt-builder.js"></script>
<script>
async function runTests() {
  const out = document.getElementById("output");
  function log(msg) { out.textContent += msg + "\n"; }

  // Test 1: buildPagePrompt
  const pagePrompt = buildPagePrompt("https://example.com/article", "Provide a brief summary.");
  log("Test 1 - Page prompt:");
  log(pagePrompt);
  log(pagePrompt.includes("https://example.com/article") ? "PASS" : "FAIL");
  log(pagePrompt.includes("as if I had pasted") ? "PASS" : "FAIL");

  // Test 2: buildTabsPrompt
  const tabsPrompt = buildTabsPrompt([
    { title: "Article One", url: "https://example.com/one" },
    { title: "Article Two", url: "https://example.com/two" }
  ], "Summarize in bullets.");
  log("\nTest 2 - Tabs prompt:");
  log(tabsPrompt);
  log(tabsPrompt.includes("1. Article One") ? "PASS" : "FAIL");
  log(tabsPrompt.includes("2. Article Two") ? "PASS" : "FAIL");

  // Test 3: buildSelectionPrompt
  const selPrompt = buildSelectionPrompt("Hello world", "Be concise.");
  log("\nTest 3 - Selection prompt:");
  log(selPrompt);
  log(selPrompt.includes("Hello world") ? "PASS" : "FAIL");
  log(selPrompt.startsWith("Be concise.") ? "PASS" : "FAIL");

  // Test 4: Selection truncation
  const longText = "a".repeat(15000);
  const truncPrompt = buildSelectionPrompt(longText, "Summarize.", 10000);
  log("\nTest 4 - Truncation:");
  log(truncPrompt.includes("[Text truncated at 10000 characters]") ? "PASS" : "FAIL");

  // Test 5: getPresets returns defaults
  const presets = await getPresets();
  log("\nTest 5 - Default presets:");
  log(presets.length === 3 ? "PASS" : "FAIL");
  log(presets[0].id === "concise" ? "PASS" : "FAIL");

  // Test 6: getPreset by ID
  const detailed = await getPreset("detailed");
  log("\nTest 6 - getPreset:");
  log(detailed.id === "detailed" ? "PASS" : "FAIL");

  // Test 7: getPreset fallback
  const fallback = await getPreset("nonexistent");
  log("\nTest 7 - Fallback preset:");
  log(fallback.id === "concise" ? "PASS" : "FAIL");

  // Test 8: buildArticlePrompt
  const articlePrompt = buildArticlePrompt("Provide a brief 2-3 sentence summary.");
  log("\nTest 8 - Article prompt (for file upload):");
  log(articlePrompt);
  log(articlePrompt.includes("Summarize the attached article") ? "PASS" : "FAIL");
  log(articlePrompt.includes("Provide a brief 2-3 sentence summary.") ? "PASS" : "FAIL");

  // Test 9: buildArticleFileContent - single article
  const singleFile = buildArticleFileContent([
    { title: "Test Article", byline: "Jane Doe", url: "https://example.com/article", textContent: "This is the article body." }
  ]);
  log("\nTest 9 - Single article file:");
  log(singleFile.substring(0, 200));
  log(singleFile.includes("Source: https://example.com/article") ? "PASS" : "FAIL");
  log(singleFile.includes("Title: Test Article") ? "PASS" : "FAIL");
  log(singleFile.includes("Author: Jane Doe") ? "PASS" : "FAIL");
  log(singleFile.includes("This is the article body.") ? "PASS" : "FAIL");
  log(!singleFile.includes("=== Article") ? "PASS: no multi-article header" : "FAIL");

  // Test 10: buildArticleFileContent - multiple articles
  const multiFile = buildArticleFileContent([
    { title: "First", byline: "Author A", url: "https://a.com", textContent: "Body A." },
    { title: "Second", byline: null, url: "https://b.com", textContent: "Body B." },
    { title: null, byline: null, url: "https://c.com", textContent: null, extractionFailed: true }
  ]);
  log("\nTest 10 - Multi-article file:");
  log(multiFile.substring(0, 400));
  log(multiFile.includes("=== Article 1 of 3 ===") ? "PASS" : "FAIL");
  log(multiFile.includes("=== Article 2 of 3 ===") ? "PASS" : "FAIL");
  log(multiFile.includes("=== Article 3 of 3 ===") ? "PASS" : "FAIL");
  log(multiFile.includes("Body A.") ? "PASS" : "FAIL");
  log(multiFile.includes("Body B.") ? "PASS" : "FAIL");
  log(multiFile.includes("Could not extract") ? "PASS: failed extraction noted" : "FAIL");

  // Test 11: buildArticleFileContent - no byline omits Author line
  const noBylFile = buildArticleFileContent([
    { title: "No Author", byline: null, url: "https://x.com", textContent: "Content." }
  ]);
  log("\nTest 11 - No byline:");
  log(!noBylFile.includes("Author:") ? "PASS" : "FAIL");
}
runTests();
</script>
</body>
</html>
